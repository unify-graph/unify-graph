image: golang:latest

stages:
  - build
  - reconcile
  - deploy

variables:
  CUE_VERSION: "0.15.4"

build:
  stage: build
  before_script:
    - curl -sSL https://github.com/cue-lang/cue/releases/download/v${CUE_VERSION}/cue_v${CUE_VERSION}_linux_amd64.tar.gz | tar xz
    - mv cue /usr/local/bin/
    - apt-get update -qq && apt-get install -y -qq python3 python3-pip python3-venv > /dev/null
    - python3 -m venv .venv
    - .venv/bin/pip install -q -r requirements.txt
  script:
    - cue vet ./...
    - mkdir -p site/data
    - cue export -e graph ./... > site/data/graph.json
    - cue export -e analysis ./... > site/data/analysis.json
    - cue export -e insights ./... > site/data/insights.json
    - cue export -e report ./... > site/data/report.json
    - cue export -e entities ./... > site/data/entities.json
    - cue export -e flows ./... > site/data/flows.json
    - cue export -e documents ./... > site/data/documents.json
    - .venv/bin/python3 scripts/analyze.py
    - .venv/bin/python3 scripts/toon_export.py
    - for f in scripts/wikidata_enriched.json scripts/propublica_enriched.json; do [ -f "$f" ] && cp "$f" "site/data/$(basename "$f")"; done
  artifacts:
    paths:
      - site/

# Manual: refresh Wikidata QIDs for new/changed entities.
# Outputs updated scripts/wikidata_qids.json and external_ids.cue.
# Review diffs before committing â€” disambiguation errors are common.
wikidata-reconcile:
  stage: reconcile
  before_script:
    - curl -sSL https://github.com/cue-lang/cue/releases/download/v${CUE_VERSION}/cue_v${CUE_VERSION}_linux_amd64.tar.gz | tar xz
    - mv cue /usr/local/bin/
    - apt-get update -qq && apt-get install -y -qq python3 python3-venv > /dev/null
    - python3 -m venv .venv
    - cue export -e entities ./... > site/data/entities.json
  script:
    - .venv/bin/python3 scripts/wikidata_reconcile.py
  artifacts:
    paths:
      - scripts/wikidata_qids.json
      - external_ids.cue
  when: manual
  allow_failure: true

pages:
  stage: deploy
  dependencies:
    - build
  script:
    - mv site public
  artifacts:
    paths:
      - public
  only:
    - main

surge:
  stage: deploy
  dependencies:
    - build
  before_script:
    - npm install -g surge
  script:
    - surge site/ unify-missing-links.surge.sh
  only:
    - main
  when: manual
  allow_failure: true
